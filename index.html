<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rebar End Points Labeler (Text Markup Test)</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
  <style>
    body {
      padding: 1rem;
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h3 { margin-bottom: 1rem; }
    #status {
      margin: 1rem 0;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .btn { margin: 0.25rem; }
    .info {
      margin-top: auto;
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>

  <h3>Rebar End Points Labeler – Text Markup Test</h3>

  <div id="status" class="text-info">Connecting to viewer...</div>

  <div>
    <button class="btn btn-success btn-lg btn-block" onclick="addTextLabelsTest()">
      Add Text Labels "TEST LABEL" at Origin (0,0,0)
    </button>
    <button class="btn btn-primary btn-lg btn-block" onclick="addTextLabelsOnRebar()">
      Add Text Labels on Selected Rebar (Using Bounding Box)
    </button>
    <button class="btn btn-danger btn-lg btn-block" onclick="clearAllMarkups()">
      Clear All Markups
    </button>
  </div>

  <div class="info mt-4">
    <p><strong>Test for Text Markups (not Single Point)</strong></p>
    <p>Single point markups may not be visible or fully supported in extensions – switching to regular text markups.</p>
    <p>First button adds a huge "TEST LABEL" at origin (0,0,0) – fit view to see it.</p>
    <p>Second button adds "TEST REBAR LABEL" near selected rebar centers.</p>
  </div>

  <script>
    let workspaceApi = null;
    let viewer = null;
    let markup = null;
    const statusEl = document.getElementById('status');

    async function initExtension() {
      try {
        workspaceApi = await TrimbleConnectWorkspace.connect(window.parent);
        viewer = workspaceApi.viewer;
        markup = workspaceApi.markup;
        statusEl.textContent = "Connected – Ready to use!";
        statusEl.className = "text-success";
        console.log("Connected – MarkupAPI:", !!markup);
      } catch (error) {
        statusEl.textContent = "Connection failed: " + (error?.message || error);
        statusEl.className = "text-danger";
        console.error(error);
      }
    }

    async function addTextLabelsTest() {
      if (!markup) return alert("Markup API unavailable");

      const testMarkups = [{
        text: "TEST LABEL – TEXT MARKUP WORKING?",
        position: { x: 0, y: 0, z: 0 },
        color: { r: 255, g: 255, b: 0 },
        fontSize: 100,
        backgroundColor: { r: 255, g: 0, b: 0, a: 200 },
        bold: true
      }];

      try {
        await markup.addTextMarkup(testMarkups);
        alert("Added large text label at origin (0,0,0) – use Fit View or zoom to center to see it!");
      } catch (err) {
        console.error(err);
        alert("Failed to add text markup");
      }
    }

    async function addTextLabelsOnRebar() {
      if (!viewer || !markup) return alert("Not connected");

      const selection = await viewer.getSelection();
      if (!selection.length) return alert("Select rebar first");

      const objects = await viewer.getObjects({ selected: true });
      const textMarkups = [];
      let count = 0;

      for (const model of objects) {
        const ids = model.objects.map(o => o.id);
        const bbs = await viewer.getObjectBoundingBoxes({ modelId: model.modelId, objectRuntimeIds: ids });

        bbs.forEach(bb => {
          if (!bb || !bb.center) return;

          textMarkups.push({
            text: "TEST REBAR LABEL\nSerial: 9999\nX/Y/Z here",
            position: { x: bb.center.x, y: bb.center.y + 5, z: bb.center.z },
            color: { r: 0, g: 255, b: 255 },
            fontSize: 60,
            backgroundColor: { r: 0, g: 0, b: 0, a: 200 },
            bold: true
          });
          count++;
        });
      }

      if (count === 0) return alert("No bounding boxes");

      await markup.addTextMarkup(textMarkups);
      alert(`Added ${count} text labels on selected rebar`);
    }

    async function clearAllMarkups() {
      if (!markup) return;
      try {
        await markup.clearAll();
        alert("Cleared");
      } catch (e) {
        alert("Clear failed");
      }
    }

    initExtension();
  </script>
</body>
</html>